const { generateRandomIP } = require('../utils/generators');

/**
 * Generates a random MD5 hash (32 hex characters)
 * @returns {string} MD5 hash
 */
function generateMD5Hash() {
  const hexChars = '0123456789abcdef';
  let hash = '';
  for (let i = 0; i < 32; i++) {
    hash += hexChars[Math.floor(Math.random() * hexChars.length)];
  }
  return hash;
}

/**
 * Generates a random infected file path
 * @returns {string} File path
 */
function generateInfectedFilePath() {
  const windowsPaths = [
    '/system/lib/driver',
    '/windows/system32/svchost',
    '/windows/temp/update',
    '/users/appdata/local/temp',
    '/program files/app',
  ];

  const unixPaths = [
    '/usr/bin/service',
    '/usr/local/lib/daemon',
    '/var/tmp/process',
    '/etc/cron',
    '/opt/application/lib',
  ];

  const allPaths = [...windowsPaths, ...unixPaths];
  const basePath = allPaths[Math.floor(Math.random() * allPaths.length)];
  const extensions = ['.dll', '.exe', '.so', '.elf', '.bin'];
  const randomName = Math.random().toString(36).substring(7);
  const extension = basePath.includes('windows') ? '.dll' : '.so';

  return `${basePath}/${randomName}${extension}`;
}

/**
 * Gets behavior indicators based on malware type
 * @param {string} type - Malware type
 * @returns {Array<string>} Behavior indicators
 */
function getBehaviorIndicators(type) {
  const behaviors = {
    'Trojan': ['registry changes', 'backdoor creation', 'command execution', 'privilege escalation'],
    'Ransomware': ['file encryption', 'ransom note creation', 'file system scanning', 'backup deletion'],
    'Spyware': ['keylogging', 'data exfiltration', 'screen capture', 'credential stealing'],
    'Worm': ['network propagation', 'replication', 'resource scanning', 'system crawling'],
    'Rootkit': ['kernel modification', 'process hiding', 'system call hooking', 'boot persistence'],
  };

  return behaviors[type] || [];
}

/**
 * Calculates severity based on malware type and spread
 * @param {string} type - Malware type
 * @param {number} infectedCount - Number of infected systems
 * @returns {string} Severity level
 */
function calculateSeverity(type, infectedCount) {
  // Ransomware is always critical
  if (type === 'Ransomware') return 'Critical';

  // Others based on spread
  if (infectedCount >= 30) return 'Critical';
  if (infectedCount >= 15) return 'High';
  if (infectedCount >= 5) return 'Medium';
  return 'Low';
}

/**
 * Generates a simulated malware attack with random parameters
 * @returns {Object} Malware incident object with all simulation data
 */
function simulateMalwareAttack() {
  const malwareTypes = ['Trojan', 'Ransomware', 'Spyware', 'Worm', 'Rootkit'];
  const selectedType = malwareTypes[Math.floor(Math.random() * malwareTypes.length)];
  const infectedCount = Math.floor(Math.random() * 50) + 1;

  return {
    malwareType: selectedType,
    infectedFilePath: generateInfectedFilePath(),
    md5Hash: generateMD5Hash(),
    behaviorIndicators: getBehaviorIndicators(selectedType),
    infectedSystemsCount: infectedCount,
    severity: calculateSeverity(selectedType, infectedCount),
    sourceIP: generateRandomIP(),
    timestamp: new Date().toISOString(),
  };
}

module.exports = {
  simulateMalwareAttack,
};
